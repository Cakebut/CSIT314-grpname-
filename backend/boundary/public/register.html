<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Register User (Admin)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --text:#111; --muted:#666; --primary:#2563eb; --danger:#e11d48; }
    * { box-sizing: border-box; }
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text);
           display:grid; place-items:center; min-height:100vh; }
    .card { width:100%; max-width:560px; background:var(--card); border-radius:14px; padding:22px;
            box-shadow:0 10px 25px rgba(0,0,0,.08); }
    h1 { margin:0 0 12px; }
    p { color:var(--muted); margin:0 0 16px; }
    label { display:block; font-size:14px; margin:10px 0 6px; }
    input, select, textarea { width:100%; padding:12px 14px; border-radius:10px; border:1px solid #e5e7eb; outline:none; }
    input:focus, select:focus, textarea:focus { border-color:var(--primary); box-shadow:0 0 0 3px rgba(37,99,235,.15); }
    button { margin-top:16px; padding:12px 14px; border:0; border-radius:10px; background:var(--primary); color:#fff; font-weight:600; cursor:pointer; }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .error { color:var(--danger); margin-top:10px; }
    .hint { font-size:12px; color:var(--muted); }
    .nav { margin-top:10px; font-size:14px; }
    pre { background:#0f172a; color:#e2e8f0; padding:12px; border-radius:10px; overflow:auto; font-size:12px; }
  </style>
</head>
<body>
  <main class="card">
    <h1>Create User</h1>
    <p>Only <strong>admin</strong> users can register new accounts. You must be logged in as admin.</p>

    <form id="reg-form">
      <div class="row">
        <div>
          <label for="username">Username</label>
          <input id="username" name="username" placeholder="e.g. user42" required />
        </div>
        <div>
          <label for="password">Password</label>
          <input id="password" name="password" type="password" placeholder="Set a password" required />
        </div>
      </div>

      <label for="displayName">Display name</label>
      <input id="displayName" name="displayName" placeholder="e.g. Jane Doe" />

      <label for="role">Role</label>
      <select id="role" name="role" required>
        <option value="admin">admin</option>
        <option value="platform_manager">platform_manager</option>
        <option value="csr">csr</option>
        <option value="person_in_need">person_in_need</option>
      </select>

      <!-- Role-specific inputs -->
      <div id="role-fields"></div>

      <button type="submit">Create account</button>
      <div id="reg-error" class="error" role="alert" aria-live="polite"></div>
    </form>

    <div class="nav">
      ‚Üê <a href="/dashboard.html">Back to dashboard</a> &nbsp;|&nbsp;
      <a href="/login.html">Login</a>
    </div>

    <h3>Server response</h3>
    <pre id="reg-result">{}</pre>
  </main>

  <script src="/js/auth.js"></script>
  <script>
    const roleFields = document.getElementById("role-fields");
    const roleSelect  = document.getElementById("role");
    const renderRoleFields = () => {
      const r = roleSelect.value;
      // Build fields per role
      if (r === "admin") {
        roleFields.innerHTML = `
          <label>Permissions (comma-separated)</label>
          <input id="perm" placeholder="e.g. manage_users,view_reports" />
        `;
      } else if (r === "platform_manager") {
        roleFields.innerHTML = `
          <div class="row">
            <div>
              <label>Regions (comma-separated)</label>
              <input id="regions" placeholder="e.g. SG,MY" />
            </div>
            <div>
              <label>Uptime target (%)</label>
              <input id="uptime" type="number" step="0.01" placeholder="99.9" />
            </div>
          </div>
        `;
      } else if (r === "csr") {
        roleFields.innerHTML = `
          <div class="row">
            <div>
              <label>Queues (comma-separated)</label>
              <input id="queues" placeholder="e.g. general,priority" />
            </div>
            <div>
              <label>Active cases (comma-separated)</label>
              <input id="cases" placeholder="e.g. CASE-101,CASE-202" />
            </div>
          </div>
        `;
      } else if (r === "person_in_need") {
        roleFields.innerHTML = `
          <div class="row">
            <div>
              <label>Case ID</label>
              <input id="caseId" placeholder="e.g. PIN-9001" />
            </div>
            <div>
              <label>Assistance type</label>
              <input id="assist" placeholder="e.g. financial" />
            </div>
          </div>
        `;
      } else {
        roleFields.innerHTML = "";
      }
    };
    roleSelect.addEventListener("change", renderRoleFields);
    window.addEventListener("DOMContentLoaded", () => {
      // Guard: must be logged in as admin
      if (!Auth.getToken()) return location.href = "/login.html";

      renderRoleFields();
      const form = document.getElementById("reg-form");
      const err  = document.getElementById("reg-error");
      const out  = document.getElementById("reg-result");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        err.textContent = "";
        out.textContent = "{}";

        const role = form.role.value;
        const body = {
          username: form.username.value.trim(),
          password: form.password.value,
          role,
          profile: { displayName: form.displayName.value.trim() || undefined },
          roleData: {}
        };

        // collect roleData
        if (role === "admin") {
          const perms = (document.getElementById("perm").value || "")
            .split(",").map(s => s.trim()).filter(Boolean);
          body.roleData = { admin: { permissions: perms } };
        } else if (role === "platform_manager") {
          const regions = (document.getElementById("regions").value || "")
            .split(",").map(s => s.trim()).filter(Boolean);
          const uptime = Number(document.getElementById("uptime").value || 99.9);
          body.roleData = { platform_manager: { regions, kpis: { uptimeTarget: uptime } } };
        } else if (role === "csr") {
          const queues = (document.getElementById("queues").value || "")
            .split(",").map(s => s.trim()).filter(Boolean);
          const cases  = (document.getElementById("cases").value || "")
            .split(",").map(s => s.trim()).filter(Boolean);
          body.roleData = { csr: { queues, activeCases: cases } };
        } else if (role === "person_in_need") {
          const caseId = document.getElementById("caseId").value.trim();
          const assistanceType = document.getElementById("assist").value.trim();
          body.roleData = { person_in_need: { caseId, assistanceType } };
        }

        try {
          const created = await Auth.api("/auth/register", { method:"POST", body: JSON.stringify(body) });
          out.textContent = JSON.stringify(created, null, 2);
          // Automatically log in as the new user
          await Auth.login(body.username, body.password);
          location.href = "/dashboard.html";
        } catch (e) {
          out.textContent = JSON.stringify(e.data || e, null, 2);
          err.textContent = e?.data?.error || "Create user failed";
        }
      });
    });
  </script>
</body>
</html>
